version: '3'

includes:
  common: ../Taskfile.yml

vars:
  # Signing configuration - edit these values for your project
  SIGN_IDENTITY: "Developer ID Application: Sesame Xiaoshi Network Technology (Wuhan) Co., Ltd. (X7Q4CHLWN6)"
  KEYCHAIN_PROFILE: "willclaw-profile"
  ENTITLEMENTS: "build/darwin/entitlements.plist"

  # Docker image for cross-compilation (used when building on non-macOS)
  CROSS_IMAGE: wails-cross

tasks:
  build:
    summary: Builds the application
    cmds:
      - task: '{{if eq OS "darwin"}}build:native{{else}}build:docker{{end}}'
        vars:
          ARCH: '{{.ARCH}}'
          DEV: '{{.DEV}}'
          OUTPUT: '{{.OUTPUT}}'
    vars:
      DEFAULT_OUTPUT: '{{.BIN_DIR}}/{{.APP_NAME}}'
      OUTPUT: '{{ .OUTPUT | default .DEFAULT_OUTPUT }}'

  build:native:
    summary: Builds the application natively on macOS
    internal: true
    deps:
      - task: common:go:mod:tidy
      - task: common:build:frontend
        vars:
          BUILD_FLAGS:
            ref: .BUILD_FLAGS
          DEV:
            ref: .DEV
      - task: common:generate:icons
    cmds:
      - go build {{.BUILD_FLAGS}} -o {{.OUTPUT}}
    vars:
      APP_VERSION:
        # Cross-platform (Windows/macOS/Linux): avoid grep/sed dependencies
        sh: go run ./internal/tools/appversion -config build/config.yml
      BUILD_FLAGS: '{{if eq .DEV "true"}}-tags fts5 -buildvcs=false -gcflags=all="-l"{{else}}-tags "production fts5" -trimpath -buildvcs=false -ldflags="-w -s -X willclaw/internal/define.Version={{.APP_VERSION}}"{{end}}'
      DEFAULT_OUTPUT: '{{.BIN_DIR}}/{{.APP_NAME}}'
      OUTPUT: '{{ .OUTPUT | default .DEFAULT_OUTPUT }}'
    env:
      GOOS: darwin
      CGO_ENABLED: 1
      GOARCH: '{{.ARCH | default ARCH}}'
      CGO_CFLAGS: "-mmacosx-version-min=10.15"
      CGO_LDFLAGS: "-mmacosx-version-min=10.15"
      MACOSX_DEPLOYMENT_TARGET: "10.15"

  build:docker:
    summary: Cross-compiles for macOS using Docker (for Linux/Windows hosts)
    internal: true
    deps:
      - task: common:build:frontend
      - task: common:generate:icons
    preconditions:
      - sh: docker info > /dev/null 2>&1
        msg: "Docker is required for cross-compilation. Please install Docker."
      - sh: docker image inspect {{.CROSS_IMAGE}} > /dev/null 2>&1
        msg: |
          Docker image '{{.CROSS_IMAGE}}' not found.
          Build it first: wails3 task setup:docker
    cmds:
      - docker run --rm -v "{{.ROOT_DIR}}:/app" {{.GO_CACHE_MOUNT}} {{.REPLACE_MOUNTS}} -e APP_NAME="{{.APP_NAME}}" {{.CROSS_IMAGE}} darwin {{.DOCKER_ARCH}}
      - docker run --rm -v "{{.ROOT_DIR}}:/app" alpine chown -R $(id -u):$(id -g) /app/bin
      - mkdir -p {{.BIN_DIR}}
      - mv "bin/{{.APP_NAME}}-darwin-{{.DOCKER_ARCH}}" "{{.OUTPUT}}"
    vars:
      DOCKER_ARCH: '{{if eq .ARCH "arm64"}}arm64{{else if eq .ARCH "amd64"}}amd64{{else}}arm64{{end}}'
      DEFAULT_OUTPUT: '{{.BIN_DIR}}/{{.APP_NAME}}'
      OUTPUT: '{{ .OUTPUT | default .DEFAULT_OUTPUT }}'
      # Mount Go module cache for faster builds
      GO_CACHE_MOUNT:
        sh: 'echo "-v ${GOPATH:-$HOME/go}/pkg/mod:/go/pkg/mod"'
      # Extract replace directives from go.mod and create -v mounts for each
      # Handles both relative (=> ../) and absolute (=> /) paths
      REPLACE_MOUNTS:
        sh: |
          grep -E '^replace .* => ' go.mod 2>/dev/null | while read -r line; do
            path=$(echo "$line" | sed -E 's/^replace .* => //' | tr -d '\r')
            # Convert relative paths to absolute
            if [ "${path#/}" = "$path" ]; then
              path="$(cd "$(dirname "$path")" 2>/dev/null && pwd)/$(basename "$path")"
            fi
            # Only mount if directory exists
            if [ -d "$path" ]; then
              echo "-v $path:$path:ro"
            fi
          done | tr '\n' ' '

  build:universal:
    summary: Builds darwin universal binary (arm64 + amd64)
    deps:
      - task: build
        vars:
          ARCH: amd64
          DEV: '{{.DEV}}'
          OUTPUT: "{{.BIN_DIR}}/{{.APP_NAME}}-amd64"
      - task: build
        vars:
          ARCH: arm64
          DEV: '{{.DEV}}'
          OUTPUT: "{{.BIN_DIR}}/{{.APP_NAME}}-arm64"
    cmds:
      - task: '{{if eq OS "darwin"}}build:universal:lipo:native{{else}}build:universal:lipo:go{{end}}'

  build:universal:lipo:native:
    summary: Creates universal binary using native lipo (macOS)
    internal: true
    cmds:
      - lipo -create -output "{{.BIN_DIR}}/{{.APP_NAME}}" "{{.BIN_DIR}}/{{.APP_NAME}}-amd64" "{{.BIN_DIR}}/{{.APP_NAME}}-arm64"
      - rm "{{.BIN_DIR}}/{{.APP_NAME}}-amd64" "{{.BIN_DIR}}/{{.APP_NAME}}-arm64"

  build:universal:lipo:go:
    summary: Creates universal binary using wails3 tool lipo (Linux/Windows)
    internal: true
    cmds:
      - wails3 tool lipo -output "{{.BIN_DIR}}/{{.APP_NAME}}" -input "{{.BIN_DIR}}/{{.APP_NAME}}-amd64" -input "{{.BIN_DIR}}/{{.APP_NAME}}-arm64"
      - rm -f "{{.BIN_DIR}}/{{.APP_NAME}}-amd64" "{{.BIN_DIR}}/{{.APP_NAME}}-arm64"

  package:
    summary: Packages the application into a `.app` bundle
    deps:
      - task: build
        vars:
          ARCH: '{{.ARCH}}'
          DEV: '{{.DEV}}'
    cmds:
      - task: create:app:bundle

  package:universal:
    summary: Packages darwin universal binary (arm64 + amd64)
    deps:
      - task: build:universal
        vars:
          DEV: '{{.DEV}}'
    cmds:
      - task: create:app:bundle

  create:dmg:
    summary: Creates a `.dmg` from the `.app` bundle (internal, does NOT build/package)
    internal: true
    preconditions:
      - sh: command -v create-dmg >/dev/null 2>&1
        msg: "create-dmg not found. Install it first: brew install create-dmg"
      - sh: test -d "{{.BIN_DIR}}/{{.APP_NAME}}.app"
        msg: "App bundle not found: {{.BIN_DIR}}/{{.APP_NAME}}.app"
    cmds:
      - |
        set -euo pipefail
        APP_PATH="{{.BIN_DIR}}/{{.APP_NAME}}.app"
        DMG_PATH="{{.DMG_PATH}}"

        rm -f "$DMG_PATH"
        create-dmg \
          --volname "{{.APP_NAME}}" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --icon "{{.APP_NAME}}.app" 150 185 \
          --app-drop-link 450 185 \
          "$DMG_PATH" \
          "$APP_PATH"
    vars:
      DMG_PATH: '{{.DMG_PATH | default (printf "%s/%s-%s.dmg" .BIN_DIR .APP_NAME (.ARCH | default ARCH))}}'

  create:app:bundle:
    summary: Creates an `.app` bundle
    cmds:
      - mkdir -p "{{.BIN_DIR}}/{{.APP_NAME}}.app/Contents/MacOS"
      - mkdir -p "{{.BIN_DIR}}/{{.APP_NAME}}.app/Contents/Resources"
      - cp build/darwin/icons.icns "{{.BIN_DIR}}/{{.APP_NAME}}.app/Contents/Resources"
      - cp "{{.BIN_DIR}}/{{.APP_NAME}}" "{{.BIN_DIR}}/{{.APP_NAME}}.app/Contents/MacOS"
      - cp build/darwin/Info.plist "{{.BIN_DIR}}/{{.APP_NAME}}.app/Contents"
      - task: '{{if eq OS "darwin"}}codesign:adhoc{{else}}codesign:skip{{end}}'

  codesign:adhoc:
    summary: Ad-hoc signs the app bundle (macOS only)
    internal: true
    cmds:
      - codesign --force --deep --sign - "{{.BIN_DIR}}/{{.APP_NAME}}.app"

  codesign:skip:
    summary: Skips codesigning when cross-compiling
    internal: true
    cmds:
      - 'echo "Skipping codesign (not available on {{OS}}). Sign the .app on macOS before distribution."'

  run:
    cmds:
      - mkdir -p "{{.BIN_DIR}}/{{.APP_NAME}}.dev.app/Contents/MacOS"
      - mkdir -p "{{.BIN_DIR}}/{{.APP_NAME}}.dev.app/Contents/Resources"
      - cp build/darwin/icons.icns "{{.BIN_DIR}}/{{.APP_NAME}}.dev.app/Contents/Resources"
      - cp "{{.BIN_DIR}}/{{.APP_NAME}}" "{{.BIN_DIR}}/{{.APP_NAME}}.dev.app/Contents/MacOS"
      - cp "build/darwin/Info.dev.plist" "{{.BIN_DIR}}/{{.APP_NAME}}.dev.app/Contents/Info.plist"
      - codesign --force --deep --sign - "{{.BIN_DIR}}/{{.APP_NAME}}.dev.app"
      - '{{.BIN_DIR}}/{{.APP_NAME}}.dev.app/Contents/MacOS/{{.APP_NAME}}'

  sign:
    summary: Signs the application bundle with Developer ID
    desc: |
      Signs the .app bundle for distribution.
      Configure SIGN_IDENTITY in the vars section at the top of this file.

      Usage:
        wails3 task darwin:sign ARCH=arm64
        wails3 task darwin:sign ARCH=arm64 DEV=true
    deps:
      - task: '{{if eq .UNIVERSAL "true"}}package:universal{{else}}package{{end}}'
        vars:
          ARCH: '{{.ARCH}}'
          DEV: '{{.DEV}}'
    cmds:
      - wails3 tool sign --input "{{.BIN_DIR}}/{{.APP_NAME}}.app" --identity "{{.SIGN_IDENTITY}}" {{if .ENTITLEMENTS}}--entitlements {{.ENTITLEMENTS}}{{end}}
    vars:
      UNIVERSAL: '{{.UNIVERSAL | default "false"}}'
    preconditions:
      - sh: '[ -n "{{.SIGN_IDENTITY}}" ]'
        msg: "SIGN_IDENTITY is required. Set it in the vars section at the top of build/darwin/Taskfile.yml"

  sign:notarize:
    summary: Builds, signs .app, creates .dmg, signs & notarizes .dmg, then staples
    desc: |
      Complete distribution pipeline:
        1. Build the binary (DEV=true for dev, DEV=false for production)
        2. Package into .app bundle
        3. Sign .app with Developer ID (with entitlements & hardened runtime)
        4. Create .dmg from the signed .app
        5. Sign .dmg with Developer ID
        6. Notarize .dmg via Apple notarytool
        7. Staple the notarization ticket to .dmg

      Usage:
        wails3 task darwin:sign:notarize ARCH=arm64
        wails3 task darwin:sign:notarize ARCH=arm64 DEV=true
        wails3 task darwin:sign:notarize ARCH=amd64
        wails3 task darwin:sign:notarize UNIVERSAL=true

      Setup (one-time):
        xcrun notarytool store-credentials "{{.KEYCHAIN_PROFILE}}" --apple-id "you@email.com" --team-id "TEAMID" --password "app-specific-password"
    deps:
      - task: '{{if eq .UNIVERSAL "true"}}package:universal{{else}}package{{end}}'
        vars:
          ARCH: '{{.ARCH}}'
          DEV: '{{.DEV}}'
    vars:
      UNIVERSAL: '{{.UNIVERSAL | default "false"}}'
      TARGET_ARCH: '{{.ARCH | default ARCH}}'
      DMG_PATH: '{{if eq (.UNIVERSAL | default "false") "true"}}{{.BIN_DIR}}/{{.APP_NAME}}-universal.dmg{{else}}{{.BIN_DIR}}/{{.APP_NAME}}-{{.ARCH | default ARCH}}.dmg{{end}}'
    preconditions:
      - sh: '[ -n "{{.SIGN_IDENTITY}}" ]'
        msg: "SIGN_IDENTITY is required. Set it in the vars section at the top of build/darwin/Taskfile.yml"
      - sh: '[ -n "{{.KEYCHAIN_PROFILE}}" ]'
        msg: "KEYCHAIN_PROFILE is required. Set it in the vars section at the top of build/darwin/Taskfile.yml"
      - sh: command -v create-dmg >/dev/null 2>&1
        msg: "create-dmg not found. Install it first: brew install create-dmg"
    cmds:
      # Step 1: Sign .app with Developer ID + hardened runtime (required for notarization)
      - |
        set -euo pipefail
        echo "==> Signing .app bundle (hardened runtime)..."
        codesign --force --deep \
          --sign "{{.SIGN_IDENTITY}}" \
          --options runtime \
          {{if .ENTITLEMENTS}}--entitlements "{{.ENTITLEMENTS}}"{{end}} \
          "{{.BIN_DIR}}/{{.APP_NAME}}.app"
        echo "==> Verifying .app signature..."
        codesign --verify --verbose "{{.BIN_DIR}}/{{.APP_NAME}}.app"
      # Step 2: Create .dmg from the signed .app
      - task: create:dmg
        vars:
          DMG_PATH: '{{.DMG_PATH}}'
          ARCH: '{{.TARGET_ARCH}}'
      # Step 3: Sign .dmg with Developer ID
      - |
        echo "==> Signing .dmg..."
        codesign --force --sign "{{.SIGN_IDENTITY}}" "{{.DMG_PATH}}"
      # Step 4: Notarize .dmg
      - |
        set -euo pipefail
        echo "==> Submitting .dmg for notarization (this may take a few minutes)..."
        SUBMIT_OUTPUT=$(xcrun notarytool submit "{{.DMG_PATH}}" \
          --keychain-profile "{{.KEYCHAIN_PROFILE}}" \
          --wait 2>&1) || true
        echo "$SUBMIT_OUTPUT"

        # Extract submission id
        SUB_ID=$(echo "$SUBMIT_OUTPUT" | grep '  id:' | head -1 | awk '{print $2}')

        # Check if notarization succeeded
        if echo "$SUBMIT_OUTPUT" | grep -q 'status: Accepted'; then
          echo "==> Notarization succeeded!"
        else
          echo ""
          echo "==> Notarization FAILED. Fetching detailed log..."
          if [ -n "$SUB_ID" ]; then
            xcrun notarytool log "$SUB_ID" \
              --keychain-profile "{{.KEYCHAIN_PROFILE}}" 2>&1 || true
          fi
          exit 1
        fi
      # Step 5: Staple the notarization ticket to .dmg
      - |
        echo "==> Stapling notarization ticket..."
        xcrun stapler staple "{{.DMG_PATH}}"
      - |
        echo ""
        echo "âœ… Done! Distribution-ready .dmg:"
        echo "   {{.DMG_PATH}}"
